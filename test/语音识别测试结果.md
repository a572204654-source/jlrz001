# 语音识别功能测试结果

## 测试时间
2024-11-06

## 测试环境
- **云托管域名**: https://api.yimengpl.com
- **测试用户**: test_openid_888888 (用户ID: 7)

## 测试结果

### ✅ 通过的测试

1. **健康检查** ✅
   - 接口: `GET /health`
   - 状态: 通过
   - 响应正常

2. **登录获取Token** ✅
   - 接口: `POST /api/auth/test-login`
   - 状态: 通过
   - 成功获取JWT token
   - 用户ID: 7
   - 昵称: 测试用户

### ❌ 失败的测试

1. **语音识别（一句话识别）** ❌
   - 接口: `POST /api/realtime-voice-socketio/recognize`
   - 错误: `语音识别失败：The provided credentials could not be validated. Please check your signature is correct.`
   - **原因**: 腾讯云语音识别服务的凭证（SecretId/SecretKey）未配置或配置不正确
   - **解决方案**: 
     - 在云托管环境变量中配置 `TENCENT_SECRET_ID` 和 `TENCENT_SECRET_KEY`
     - 确保凭证有效且有语音识别服务权限

2. **获取识别历史记录** ❌
   - 接口: `GET /api/realtime-voice-socketio/history`
   - 错误: `获取历史记录失败`
   - **可能原因**: 
     - 数据库表 `voice_recognition_logs` 不存在
     - 或者查询出错

3. **获取识别统计信息** ❌
   - 接口: `GET /api/realtime-voice-socketio/stats`
   - 错误: `获取统计信息失败`
   - **可能原因**: 同上

## 问题分析

### 1. 腾讯云凭证配置问题

**错误信息**: `The provided credentials could not be validated. Please check your signature is correct.`

**检查步骤**:
1. 确认云托管环境变量中已配置：
   - `TENCENT_SECRET_ID`
   - `TENCENT_SECRET_KEY`

2. 确认凭证有效：
   - 登录腾讯云控制台
   - 检查 API 密钥是否有效
   - 确认密钥有语音识别（ASR）服务权限

3. 检查配置加载：
   ```bash
   # 在云托管中查看环境变量
   curl https://api.yimengpl.com/diagnose
   ```

### 2. 数据库表问题

**检查步骤**:
1. 确认数据库表 `voice_recognition_logs` 是否存在
2. 如果不存在，运行初始化脚本：
   ```bash
   # 查看初始化脚本
   cat scripts/init-db.sql | grep voice_recognition_logs
   ```

## 下一步操作

### 立即需要做的：

1. **配置腾讯云凭证**
   - 在云托管控制台添加环境变量：
     - `TENCENT_SECRET_ID`: 你的腾讯云SecretId
     - `TENCENT_SECRET_KEY`: 你的腾讯云SecretKey
   - 重启服务使配置生效

2. **检查数据库表**
   - 确认 `voice_recognition_logs` 表存在
   - 如果不存在，执行建表SQL

3. **重新测试**
   ```bash
   node test/test-voice-recognition-cloud.js
   ```

### 测试命令

```bash
# 运行完整测试
node test/test-voice-recognition-cloud.js

# 单独测试健康检查
curl https://api.yimengpl.com/health

# 测试登录（需要先创建测试用户）
curl -X POST https://api.yimengpl.com/api/auth/test-login \
  -H "Content-Type: application/json" \
  -d '{"openid":"test_openid_888888"}'
```

## 测试脚本位置

- 测试脚本: `test/test-voice-recognition-cloud.js`
- 测试文档: `test/README-VOICE-TEST.md`

## 相关文档

- [语音识别功能文档](../docs/VOICE_RECOGNITION.md)
- [实时语音识别文档](../README_REALTIME_VOICE.md)
- [Socket.IO云托管集成指南](../docs/Socket.IO云托管集成指南.md)

