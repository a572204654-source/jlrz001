# 数据库双地址配置说明

## 功能说明

本项目支持**自动切换数据库内外网地址**，根据运行环境自动选择最优的连接方式：

- 🏢 **云托管环境（生产环境）**：自动使用**内网地址**，速度更快、更稳定
- 💻 **本地开发环境**：自动使用**外网地址**，可以在本地直接访问

## 环境变量配置

### 方式一：自动切换（推荐）⭐

在 `.env` 文件中配置双地址：

```bash
# 环境设置
NODE_ENV=production  # 云托管设为 production，本地开发设为 development

# 数据库配置 - 内网地址（云托管环境使用）
DB_HOST_INTERNAL=10.27.100.151
DB_PORT_INTERNAL=3306

# 数据库配置 - 外网地址（本地开发使用）
DB_HOST_EXTERNAL=sh-cynosdbmysql-grp-goudlu7k.sql.tencentcdb.com
DB_PORT_EXTERNAL=22087

# 数据库通用配置
DB_USER=a572204654
DB_PASSWORD=572204654aA
DB_NAME=jlzr1101-5g9kplxza13a780d
```

### 方式二：手动指定（备用）

如果需要手动控制，可以只设置通用变量：

```bash
# 手动指定地址
DB_HOST=10.27.100.151  # 或外网地址
DB_PORT=3306           # 或外网端口
DB_USER=a572204654
DB_PASSWORD=572204654aA
DB_NAME=jlzr1101-5g9kplxza13a780d
```

## 云托管平台环境变量配置

在腾讯云 CloudBase 云托管平台的**环境变量设置**中配置：

### 基础配置（必需）

```bash
NODE_ENV=production
```

### 数据库配置（内网）

```bash
DB_HOST_INTERNAL=10.27.100.151
DB_PORT_INTERNAL=3306
DB_USER=a572204654
DB_PASSWORD=572204654aA
DB_NAME=jlzr1101-5g9kplxza13a780d
```

### 数据库配置（外网备用）

```bash
DB_HOST_EXTERNAL=sh-cynosdbmysql-grp-goudlu7k.sql.tencentcdb.com
DB_PORT_EXTERNAL=22087
```

### 其他配置

```bash
# 微信小程序
WECHAT_APPID=wxbd778f929f40d8c2
WECHAT_APPSECRET=d2408b2a5907c6ade1bd17b2f75f0e65

# JWT密钥
JWT_SECRET=supervision-log-jwt-secret-XyZ9@2024!Abc

# 豆包AI
DOUBAO_API_KEY=af1085bd-3749-4303-bbd3-efcb287194fa
DOUBAO_ENDPOINT_ID=ep-20251106172018-dglqw

# 和风天气
QWEATHER_API_KEY=d7eb9f449c434e7f8a8cc32aab171128

# 服务端口
PORT=80
```

## 自动切换逻辑

代码会根据 `NODE_ENV` 环境变量自动选择：

```javascript
// config/index.js
database: {
  host: process.env.NODE_ENV === 'production' 
    ? (process.env.DB_HOST_INTERNAL || '10.27.100.151')      // 生产环境用内网
    : (process.env.DB_HOST_EXTERNAL || '外网地址'),            // 开发环境用外网
  port: process.env.NODE_ENV === 'production'
    ? parseInt(process.env.DB_PORT_INTERNAL || '3306')
    : parseInt(process.env.DB_PORT_EXTERNAL || '22087'),
  // ... 其他配置
}
```

## 使用场景

### 场景一：本地开发

1. 设置 `.env` 文件：
   ```bash
   NODE_ENV=development
   ```

2. 启动项目：
   ```bash
   npm start
   ```

3. 查看日志输出：
   ```
   ==================================
   数据库连接配置:
   环境: development
   地址: sh-cynosdbmysql-grp-goudlu7k.sql.tencentcdb.com:22087
   数据库: jlzr1101-5g9kplxza13a780d
   用户: a572204654
   连接类型: 外网
   ==================================
   ```

### 场景二：云托管部署

1. 在云托管平台设置环境变量：
   ```bash
   NODE_ENV=production
   DB_HOST_INTERNAL=10.27.100.151
   DB_PORT_INTERNAL=3306
   ```

2. 部署后查看日志：
   ```
   ==================================
   数据库连接配置:
   环境: production
   地址: 10.27.100.151:3306
   数据库: jlzr1101-5g9kplxza13a780d
   用户: a572204654
   连接类型: 内网
   ==================================
   ```

### 场景三：本地测试生产环境

如果想在本地测试使用内网地址（需要VPN或内网访问）：

```bash
NODE_ENV=production npm start
```

## 优势

✅ **自动化**：无需修改代码，环境变量自动切换  
✅ **灵活性**：支持内外网地址同时配置  
✅ **安全性**：敏感信息通过环境变量管理  
✅ **可见性**：启动时输出连接信息，便于确认  
✅ **容错性**：提供默认值，避免配置遗漏  

## 故障排查

### 连接失败

1. **检查环境变量**：
   ```bash
   echo $NODE_ENV
   ```

2. **查看启动日志**：
   确认使用的地址和端口是否正确

3. **测试连接**：
   ```bash
   # 测试外网
   telnet sh-cynosdbmysql-grp-goudlu7k.sql.tencentcdb.com 22087
   
   # 测试内网（需在云托管环境内）
   telnet 10.27.100.151 3306
   ```

### 环境变量不生效

1. 确认 `.env` 文件在项目根目录
2. 重启应用服务
3. 检查是否有其他地方覆盖了环境变量

## 注意事项

⚠️ **内网地址仅在云托管环境内可用**  
⚠️ **外网地址需要配置白名单**  
⚠️ **生产环境务必使用 `NODE_ENV=production`**  
⚠️ **数据库密码请妥善保管，不要提交到代码仓库**  

## 完整的云托管环境变量清单

```bash
# 环境
NODE_ENV=production

# 数据库 - 内网（主用）
DB_HOST_INTERNAL=10.27.100.151
DB_PORT_INTERNAL=3306

# 数据库 - 外网（备用）
DB_HOST_EXTERNAL=sh-cynosdbmysql-grp-goudlu7k.sql.tencentcdb.com
DB_PORT_EXTERNAL=22087

# 数据库 - 通用
DB_USER=a572204654
DB_PASSWORD=572204654aA
DB_NAME=jlzr1101-5g9kplxza13a780d

# 微信小程序
WECHAT_APPID=wxbd778f929f40d8c2
WECHAT_APPSECRET=d2408b2a5907c6ade1bd17b2f75f0e65

# JWT
JWT_SECRET=supervision-log-jwt-secret-XyZ9@2024!Abc

# 豆包AI
DOUBAO_API_KEY=af1085bd-3749-4303-bbd3-efcb287194fa
DOUBAO_ENDPOINT_ID=ep-20251106172018-dglqw
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3

# 和风天气
QWEATHER_API_KEY=d7eb9f449c434e7f8a8cc32aab171128

# 服务
PORT=80
```

---

**最后更新**：2024-11-07  
**版本**：v1.0.0

