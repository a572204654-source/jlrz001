# ç›‘ç†æ—¥å¿—Wordå¯¼å‡ºæ ¼å¼è¯´æ˜

## æ›´æ–°æ—¥æœŸ
2024-11-07

## åŠŸèƒ½æ¦‚è¿°
ç›‘ç†æ—¥å¿—Wordå¯¼å‡ºåŠŸèƒ½å·²æŒ‰ç…§æ ‡å‡†ç›‘ç†æ—¥å¿—æ ¼å¼è¿›è¡Œ1:1è¿˜åŸï¼Œç”Ÿæˆç¬¦åˆå·¥ç¨‹ç›‘ç†è§„èŒƒçš„ä¸“ä¸šæ–‡æ¡£ã€‚

## æ ¼å¼ç‰¹ç‚¹

### 1. æ–‡æ¡£ç»“æ„
- **æ ‡é¢˜**ï¼šç›‘ç†æ—¥å¿—ï¼ˆå±…ä¸­ï¼Œ22ptï¼Œå®‹ä½“ï¼ŒåŠ ç²—ï¼‰
- **ä¸»è¡¨æ ¼**ï¼šåŒ…å«æ‰€æœ‰ç›‘ç†æ—¥å¿—ä¿¡æ¯çš„ç»Ÿä¸€è¡¨æ ¼
- **ç­¾ååŒº**ï¼šè®°å½•äººå’Œå®¡æ ¸äººç­¾åæ 

### 2. è¡¨æ ¼å¸ƒå±€

#### ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬ä¿¡æ¯
| å­—æ®µ | è¯´æ˜ | æ ·å¼ |
|------|------|------|
| å•ä½å·¥ç¨‹åç§° | å·¥ç¨‹åç§° | å·¦å¯¹é½ï¼Œ12pt |
| å•ä½å·¥ç¨‹ç¼–å· | å·¥ç¨‹ç¼–å· | å·¦å¯¹é½ï¼Œ12pt |
| æ—¥æœŸ | æ—¥å¿—æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYå¹´MMæœˆDDæ—¥ï¼‰ | å·¦å¯¹é½ï¼Œ12pt |
| æ°”è±¡ | å¤©æ°”æƒ…å†µ | å·¦å¯¹é½ï¼Œ12pt |

#### ç¬¬äºŒéƒ¨åˆ†ï¼šå†…å®¹åŒºåŸŸ
ä¸‰ä¸ªä¸»è¦å†…å®¹åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸåŒ…å«ï¼š
- **æ ‡é¢˜åˆ—**ï¼ˆç«–æ’ï¼‰ï¼šå®½åº¦6%ï¼Œå±…ä¸­ï¼ŒåŠ ç²—
- **å†…å®¹åˆ—**ï¼šå®½åº¦94%ï¼Œå¸¦ç¼©è¿›ï¼Œ1.5å€è¡Œè·

1. **å·¥ç¨‹åŠ¨æ€**
   - è®°å½•å½“æ—¥å·¥ç¨‹æ–½å·¥æƒ…å†µ
   - æœ€å°é«˜åº¦ï¼š2000 twips

2. **ç›‘ç†å·¥ä½œæƒ…å†µ**
   - è®°å½•ç›‘ç†å·¥ä½œå†…å®¹
   - æœ€å°é«˜åº¦ï¼š2000 twips

3. **å®‰å…¨ç›‘ç†å·¥ä½œæƒ…å†µ**
   - è®°å½•å®‰å…¨ç›‘ç†æ£€æŸ¥æƒ…å†µ
   - æœ€å°é«˜åº¦ï¼š2000 twips

#### ç¬¬ä¸‰éƒ¨åˆ†ï¼šç­¾ååŒº
| è®°å½•äºº | å§“å | å¹´ æœˆ æ—¥ | å®¡æ ¸äºº | å§“å | å¹´ æœˆ æ—¥ |
|-------|------|---------|--------|------|----------|
| 6åˆ—å¸ƒå±€ | å±…ä¸­å¯¹é½ | 12ptå®‹ä½“ |

### 3. æŠ€æœ¯å®ç°

#### ä½¿ç”¨çš„åº“
- **docx**: ä¸“ä¸šçš„Wordæ–‡æ¡£ç”Ÿæˆåº“
- ç‰ˆæœ¬: ^9.0.0

#### ä¸»è¦ç‰¹æ€§
âœ… å®Œæ•´çš„è¡¨æ ¼è¾¹æ¡†æ§åˆ¶  
âœ… å•å…ƒæ ¼åˆå¹¶æ”¯æŒ  
âœ… ç«–æ’æ–‡å­—ï¼ˆTextDirection.BOTTOM_TO_TOP_LEFT_TO_RIGHTï¼‰  
âœ… ç²¾ç¡®çš„åˆ—å®½æ§åˆ¶ï¼ˆç™¾åˆ†æ¯”ï¼‰  
âœ… è¡Œé«˜æ§åˆ¶ï¼ˆæœ€å°é«˜åº¦ï¼‰  
âœ… å‚ç›´å±…ä¸­å¯¹é½  
âœ… æ®µè½ç¼©è¿›å’Œè¡Œè·  
âœ… å­—ä½“å’Œå­—å·å®Œå…¨æ§åˆ¶  

## API æ¥å£

### å¯¼å‡ºç›‘ç†æ—¥å¿—

#### è¯·æ±‚
```
GET /api/supervision-logs/:id/export
GET /api/v1/supervision-logs/:id/export
```

#### è¯·æ±‚å¤´
```
Authorization: Bearer {token}
```
æˆ–
```
token: {token}
```

#### å‚æ•°
- `id`: ç›‘ç†æ—¥å¿—IDï¼ˆè·¯å¾„å‚æ•°ï¼‰

#### å“åº”
- **Content-Type**: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- **Content-Disposition**: `attachment; filename="ç›‘ç†æ—¥å¿—_2024-11-07.docx"`
- **å“åº”ä½“**: Wordæ–‡æ¡£äºŒè¿›åˆ¶æµ

#### ç¤ºä¾‹ï¼ˆä½¿ç”¨axiosï¼‰
```javascript
const axios = require('axios')
const fs = require('fs')

async function exportLog(logId, token) {
  const response = await axios({
    url: `http://localhost/api/supervision-logs/${logId}/export`,
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    responseType: 'arraybuffer'
  })
  
  fs.writeFileSync('ç›‘ç†æ—¥å¿—.docx', response.data)
  console.log('å¯¼å‡ºæˆåŠŸï¼')
}
```

## å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

### ä½¿ç”¨æ–¹æ³•

```javascript
// åœ¨å°ç¨‹åºä¸­è°ƒç”¨å¯¼å‡ºæ¥å£
wx.downloadFile({
  url: `${API_BASE_URL}/api/supervision-logs/${logId}/export`,
  header: {
    'token': wx.getStorageSync('token')
  },
  success(res) {
    if (res.statusCode === 200) {
      // è·å–ä¸´æ—¶æ–‡ä»¶è·¯å¾„
      const filePath = res.tempFilePath
      
      // æ‰“å¼€æ–‡æ¡£
      wx.openDocument({
        filePath: filePath,
        fileType: 'docx',
        success: function() {
          console.log('æ‰“å¼€æ–‡æ¡£æˆåŠŸ')
        },
        fail: function(err) {
          console.error('æ‰“å¼€æ–‡æ¡£å¤±è´¥', err)
          wx.showToast({
            title: 'æ‰“å¼€æ–‡æ¡£å¤±è´¥',
            icon: 'none'
          })
        }
      })
    }
  },
  fail(err) {
    console.error('ä¸‹è½½å¤±è´¥', err)
    wx.showToast({
      title: 'å¯¼å‡ºå¤±è´¥',
      icon: 'none'
    })
  }
})
```

### å®Œæ•´ç¤ºä¾‹ï¼ˆå¸¦åŠ è½½æç¤ºï¼‰

```javascript
// pages/log-detail/index.js

// å¯¼å‡ºWordæ–‡æ¡£
exportWord() {
  const logId = this.data.logId
  
  wx.showLoading({
    title: 'æ­£åœ¨å¯¼å‡º...',
    mask: true
  })
  
  wx.downloadFile({
    url: `${app.globalData.apiBaseUrl}/api/supervision-logs/${logId}/export`,
    header: {
      'token': wx.getStorageSync('token')
    },
    success: (res) => {
      wx.hideLoading()
      
      if (res.statusCode === 200) {
        wx.openDocument({
          filePath: res.tempFilePath,
          fileType: 'docx',
          showMenu: true,
          success: () => {
            wx.showToast({
              title: 'å¯¼å‡ºæˆåŠŸ',
              icon: 'success'
            })
          },
          fail: (err) => {
            console.error('æ‰“å¼€æ–‡æ¡£å¤±è´¥', err)
            wx.showToast({
              title: 'æ‰“å¼€æ–‡æ¡£å¤±è´¥',
              icon: 'none'
            })
          }
        })
      } else {
        wx.showToast({
          title: 'å¯¼å‡ºå¤±è´¥',
          icon: 'none'
        })
      }
    },
    fail: (err) => {
      wx.hideLoading()
      console.error('ä¸‹è½½å¤±è´¥', err)
      wx.showToast({
        title: 'ç½‘ç»œé”™è¯¯',
        icon: 'none'
      })
    }
  })
}
```

### WXML æŒ‰é’®ç¤ºä¾‹

```xml
<view class="action-buttons">
  <button class="export-btn" bindtap="exportWord">
    <text class="icon">ğŸ“„</text>
    <text>å¯¼å‡ºWord</text>
  </button>
</view>
```

### WXSS æ ·å¼ç¤ºä¾‹

```css
.action-buttons {
  padding: 20rpx 30rpx;
  display: flex;
  justify-content: center;
}

.export-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 10rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20rpx 40rpx;
  box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.3);
}

.export-btn .icon {
  margin-right: 10rpx;
  font-size: 36rpx;
}
```

## æ•°æ®æ ¼å¼è¦æ±‚

### è¾“å…¥æ•°æ®ç»“æ„
```javascript
{
  work_name: 'å·¥ç¨‹åç§°',           // å¿…å¡«
  work_code: 'å·¥ç¨‹ç¼–å·',           // å¿…å¡«
  log_date: Date,                  // æ—¥å¿—æ—¥æœŸï¼Œå¿…å¡«
  weather: 'å¤©æ°”æƒ…å†µ',             // é€‰å¡«
  project_dynamics: 'å·¥ç¨‹åŠ¨æ€å†…å®¹', // é€‰å¡«
  supervision_work: 'ç›‘ç†å·¥ä½œå†…å®¹', // é€‰å¡«
  safety_work: 'å®‰å…¨ç›‘ç†å·¥ä½œå†…å®¹',  // é€‰å¡«
  recorder_name: 'è®°å½•äººå§“å',      // é€‰å¡«
  reviewer_name: 'å®¡æ ¸äººå§“å'       // é€‰å¡«
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| work_name | String | æ˜¯ | å•ä½å·¥ç¨‹åç§° |
| work_code | String | æ˜¯ | å•ä½å·¥ç¨‹ç¼–å· |
| log_date | Date/String | æ˜¯ | æ—¥å¿—æ—¥æœŸï¼Œæ ¼å¼åŒ–ä¸º"YYYYå¹´MMæœˆDDæ—¥" |
| weather | String | å¦ | æ°”è±¡æƒ…å†µï¼Œå¦‚"æ™´ï¼Œ15-25â„ƒ" |
| project_dynamics | String | å¦ | å·¥ç¨‹åŠ¨æ€è¯¦ç»†å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ |
| supervision_work | String | å¦ | ç›‘ç†å·¥ä½œæƒ…å†µè¯¦ç»†å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ |
| safety_work | String | å¦ | å®‰å…¨ç›‘ç†å·¥ä½œæƒ…å†µè¯¦ç»†å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ |
| recorder_name | String | å¦ | è®°å½•äººå§“å |
| reviewer_name | String | å¦ | å®¡æ ¸äººå§“å |

## æµ‹è¯•

### æœ¬åœ°æµ‹è¯•
è¿è¡Œæµ‹è¯•è„šæœ¬ç”Ÿæˆç¤ºä¾‹Wordæ–‡æ¡£ï¼š

```bash
node scripts/test-word-export.js
```

ç”Ÿæˆçš„æ–‡æ¡£ä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼š`test-ç›‘ç†æ—¥å¿—.docx`

### APIæµ‹è¯•
1. å¯åŠ¨æœåŠ¡å™¨ï¼š`npm start`
2. ä½¿ç”¨Postmanæˆ–Apifoxæµ‹è¯•å¯¼å‡ºæ¥å£
3. è®¾ç½®å“åº”ç±»å‹ä¸º `binary`

## æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶å¤§å°
- ç©ºç™½æ¨¡æ¿ï¼šçº¦8-10KB
- å¸¦å†…å®¹ï¼šæ ¹æ®å†…å®¹é•¿åº¦ï¼Œä¸€èˆ¬10-50KB

### 2. æµè§ˆå™¨ä¸‹è½½
å¦‚æœåœ¨Webç«¯ä¸‹è½½ï¼Œéœ€è¦æ­£ç¡®è®¾ç½®å“åº”å¤´ï¼š
```javascript
res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')
res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(fileName)}"`)
```

### 3. ä¸­æ–‡æ–‡ä»¶å
æ–‡ä»¶åéœ€è¦ä½¿ç”¨ `encodeURIComponent()` è¿›è¡Œç¼–ç ï¼Œç¡®ä¿ä¸­æ–‡æ­£å¸¸æ˜¾ç¤ºã€‚

### 4. æ¢è¡Œç¬¦
å†…å®¹ä¸­çš„æ¢è¡Œç¬¦ï¼ˆ`\n`ï¼‰ä¼šè¢«æ­£ç¡®å¤„ç†ï¼Œç”Ÿæˆå¤šä¸ªæ®µè½ã€‚

### 5. ç‰¹æ®Šå­—ç¬¦
å†…å®¹ä¸­çš„ç‰¹æ®Šå­—ç¬¦ä¼šè¢«è‡ªåŠ¨è½¬ä¹‰ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†ã€‚

## å‡çº§è¯´æ˜

### ä»æ—§ç‰ˆæœ¬å‡çº§
å¦‚æœæ‚¨çš„é¡¹ç›®ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬çš„ `officegen` å®ç°ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å‡çº§ï¼š

1. **å®‰è£…æ–°ä¾èµ–**
```bash
npm install docx --save
```

2. **æ›¿æ¢æ–‡ä»¶**
ç›´æ¥æ›¿æ¢ `utils/wordGenerator.js` æ–‡ä»¶

3. **æµ‹è¯•éªŒè¯**
```bash
node scripts/test-word-export.js
```

4. **æ— éœ€ä¿®æ”¹API**
å¯¼å‡ºæ¥å£ä»£ç æ— éœ€ä¿®æ”¹ï¼Œå®Œå…¨å…¼å®¹

### ç‰ˆæœ¬å¯¹æ¯”

| é¡¹ç›® | æ—§ç‰ˆæœ¬(officegen) | æ–°ç‰ˆæœ¬(docx) |
|------|------------------|-------------|
| è¡¨æ ¼æ§åˆ¶ | æœ‰é™ | å®Œå…¨æ§åˆ¶ |
| ç«–æ’æ–‡å­— | ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| å•å…ƒæ ¼åˆå¹¶ | æœ‰é™ | âœ… å®Œå…¨æ”¯æŒ |
| æ–‡ä»¶å¤§å° | è¾ƒå¤§ | è¾ƒå° |
| æ ¼å¼è¿˜åŸåº¦ | 70% | 95%+ |
| å…¼å®¹æ€§ | ä¸€èˆ¬ | ä¼˜ç§€ |

## æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. âœ… æ˜¯å¦æ­£ç¡®å®‰è£…äº† `docx` ä¾èµ–
2. âœ… æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
3. âœ… æ—¥æœŸå­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ
4. âœ… æ˜¯å¦æœ‰æ­£ç¡®çš„è®¤è¯token
5. âœ… æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ

## å¼€å‘è€…ä¿¡æ¯

- **å®ç°æ–‡ä»¶**: `utils/wordGenerator.js`
- **è·¯ç”±æ–‡ä»¶**: `routes/supervision-log.js`, `routes/v1/supervision-log.js`
- **ä¾èµ–åº“**: `docx@^9.0.0`
- **æµ‹è¯•è„šæœ¬**: `scripts/test-word-export.js`

---

**æœ€åæ›´æ–°**: 2024-11-07  
**ç‰ˆæœ¬**: v2.0.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆ1:1æ ¼å¼è¿˜åŸ

