# WebSocket 连接超时问题排查指南

## 问题现象

- WebSocket 状态显示为 `OPEN`（连接已建立）
- 但连接状态显示为 `false`（未收到欢迎消息）
- 15 秒后超时，提示"WebSocket连接超时"

## 可能原因

### 1. 微信小程序域名配置问题（最常见）

**症状**：连接可以建立（状态为 OPEN），但无法接收消息

**解决方案**：
1. 登录微信小程序管理后台
2. 进入：开发 → 开发管理 → 开发设置 → 服务器域名
3. 在"socket合法域名"中添加：`wss://api.yimengpl.com`
4. 保存后等待 5-10 分钟生效
5. 重新打开小程序测试

**注意**：
- 正式环境必须配置 socket 合法域名
- 开发环境可以在开发工具中勾选"不校验合法域名"
- 域名配置后需要等待一段时间才能生效

### 2. 网络连接问题

**检查项**：
- 检查网络连接是否正常（WiFi/移动数据）
- 尝试切换网络环境
- 检查防火墙设置
- 尝试在浏览器中访问：`https://api.yimengpl.com`

### 3. 服务器响应慢

**检查项**：
- 检查服务器日志，确认是否收到连接请求
- 检查服务器是否正常发送欢迎消息
- 检查服务器负载是否过高

### 4. 代理或中间件问题

**检查项**：
- 检查是否有代理服务器
- 检查是否有负载均衡器
- 检查是否有 WebSocket 代理配置

## 已实施的优化

### 服务器端优化

1. **状态检查**：发送消息前检查 WebSocket 状态（readyState === 1）
2. **延迟重试**：如果未就绪，延迟 100ms 后重试发送
3. **错误处理**：添加 try-catch 确保消息发送失败时不会崩溃
4. **详细日志**：记录消息发送状态，便于排查问题

### 客户端优化

1. **自动重试**：连接超时后自动重试（最多 3 次）
2. **详细日志**：记录连接时间、消息接收时间等
3. **错误提示**：使用 `wx.showModal` 显示更友好的错误提示
4. **状态跟踪**：跟踪重试次数，避免无限重试

## 排查步骤

### 步骤 1：检查微信小程序域名配置

1. 登录微信小程序管理后台
2. 检查 socket 合法域名是否包含 `wss://api.yimengpl.com`
3. 如果未配置，按照上述步骤配置

### 步骤 2：检查服务器日志

查看服务器日志，确认：
- 是否收到连接请求
- 是否成功发送欢迎消息
- 是否有错误信息

### 步骤 3：检查客户端日志

在小程序开发工具中查看控制台日志：
- 连接时间
- 是否收到欢迎消息
- 消息内容
- 错误信息

### 步骤 4：测试连接

1. 使用小程序开发工具测试
2. 使用真机调试测试
3. 检查不同网络环境下的表现

## 代码改进说明

### 服务器端（routes/realtime-voice.js）

```javascript
// 检查 WebSocket 状态，确保连接已就绪
if (ws.readyState === 1) { // 1 = OPEN
  ws.send(welcomeMessage)
  console.log('✅ 欢迎消息已发送')
} else {
  // 如果未就绪，等待一下再发送
  setTimeout(() => {
    if (ws.readyState === 1) {
      ws.send(welcomeMessage)
      console.log('✅ 欢迎消息已延迟发送')
    }
  }, 100)
}
```

### 客户端（miniapp-example/pages/realtime-voice/realtime-voice.js）

```javascript
// 自动重试机制
if (that.reconnectCount < 3) {
  that.reconnectCount++
  console.log(`🔄 尝试重新连接 (${that.reconnectCount}/3)...`)
  
  // 延迟后重新连接
  setTimeout(() => {
    that.connectWebSocket()
  }, 2000)
}
```

## 常见问题

### Q: 为什么连接状态是 OPEN 但还是超时？

A: 连接状态为 OPEN 只表示 WebSocket 连接已建立，但不代表消息能够正常传输。可能的原因：
- 微信小程序域名未配置
- 消息在传输过程中丢失
- 服务器没有正确发送消息

### Q: 如何确认域名配置是否生效？

A: 
1. 在微信小程序管理后台查看配置
2. 等待 5-10 分钟
3. 重新打开小程序测试
4. 如果仍然失败，检查域名格式是否正确（必须是 `wss://` 开头）

### Q: 开发环境可以连接，正式环境不行？

A: 这是典型的域名配置问题。开发环境可以在开发工具中勾选"不校验合法域名"，但正式环境必须配置 socket 合法域名。

### Q: 重试机制会无限重试吗？

A: 不会。代码中设置了最多重试 3 次，超过 3 次后会显示错误提示，不再重试。

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：
1. 服务器日志（包含连接和消息发送记录）
2. 客户端日志（包含连接时间和错误信息）
3. 微信小程序域名配置截图
4. 网络环境信息（WiFi/移动数据）

---

**最后更新**：2024-11-06
**版本**：v1.1.0

