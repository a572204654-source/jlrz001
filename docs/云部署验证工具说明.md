# 云部署API验证工具完整说明

## 概述

本项目提供了一套完整的API接口验证工具，帮助你快速验证云部署后的服务是否正常工作。

## 工具清单

### 1. 交互式验证工具 ⭐⭐⭐ (推荐新手)

**文件**: `test/interactive-verify.js`

**特点**:
- ✅ 一步步引导
- ✅ 详细的说明和建议
- ✅ 实时反馈
- ✅ 友好的用户界面

**使用方法**:
```bash
npm run verify-interactive
```

**适用场景**:
- 第一次部署后的验证
- 不熟悉命令行的用户
- 需要详细指导的场景

---

### 2. 快速验证工具 ⭐⭐⭐ (推荐日常使用)

**文件**: `test/quick-verify.js`

**特点**:
- ✅ 快速执行（< 10秒）
- ✅ 验证关键接口
- ✅ 清晰的输出
- ✅ 适合自动化

**使用方法**:
```bash
# 方法1: 直接传入URL
node test/quick-verify.js https://your-cloud-url.com

# 方法2: 使用环境变量
export API_BASE_URL="https://your-cloud-url.com"
npm run verify-quick

# Windows PowerShell
$env:API_BASE_URL="https://your-cloud-url.com"
npm run verify-quick
```

**适用场景**:
- 日常部署后的快速检查
- CI/CD流程集成
- 定时监控
- 快速排查问题

---

### 3. 完整验证工具 ⭐⭐ (推荐深度测试)

**文件**: `test/api-verification.js`

**特点**:
- ✅ 全面的测试覆盖
- ✅ 详细的测试报告
- ✅ 边界情况测试
- ✅ 性能基准测试

**使用方法**:
```bash
export API_BASE_URL="https://your-cloud-url.com"
npm run verify-api
```

**适用场景**:
- 重大更新后的全面测试
- 性能评估
- 问题深度排查
- 发布前的最终验证

---

## 验证内容对比

| 验证项目 | 交互式 | 快速 | 完整 |
|---------|--------|------|------|
| 健康检查 | ✅ | ✅ | ✅ |
| 环境诊断 | ✅ | ✅ | ✅ |
| API根路径 | ✅ | ✅ | ✅ |
| 天气API | ✅ | ✅ | ✅ |
| 用户统计 | ❌ | ❌ | ✅ |
| 项目列表 | ✅ | ✅ | ✅ |
| 工程列表 | ✅ | ✅ | ✅ |
| 日志列表 | ✅ | ✅ | ✅ |
| 项目详情 | ❌ | ❌ | ✅ |
| 工程详情 | ❌ | ❌ | ✅ |
| 日志详情 | ❌ | ❌ | ✅ |
| 权限保护 | ✅ | ✅ | ✅ |
| 404处理 | ❌ | ❌ | ✅ |
| WebSocket | ❌ | ❌ | ✅ |
| 执行时间 | ~30秒 | ~10秒 | ~60秒 |

---

## 使用流程建议

### 首次部署

```bash
# 1. 使用交互式工具进行首次验证
npm run verify-interactive

# 2. 如果发现问题，查看详细文档
cat docs/API接口验证指南.md

# 3. 修复问题后，使用快速验证确认
node test/quick-verify.js https://your-url.com

# 4. 最后使用完整验证进行全面测试
export API_BASE_URL="https://your-url.com"
npm run verify-api
```

### 日常部署

```bash
# 快速验证即可
node test/quick-verify.js https://your-url.com
```

### 问题排查

```bash
# 1. 先用快速验证定位问题
node test/quick-verify.js https://your-url.com

# 2. 使用完整验证深度测试
npm run verify-api

# 3. 查看环境诊断
curl https://your-url.com/diagnose

# 4. 查看健康状态
curl https://your-url.com/health
```

---

## 验证清单

### 基础验证 ⭐⭐⭐

- [ ] 健康检查返回 `{"status":"ok"}`
- [ ] 环境诊断无警告 (`diagnosis.warning` 为 `null`)
- [ ] 数据库地址不是 `localhost`

### 功能验证 ⭐⭐

- [ ] 天气API可以查询
- [ ] 项目列表可以访问
- [ ] 工程列表可以访问
- [ ] 监理日志列表可以访问

### 安全验证 ⭐⭐⭐

- [ ] 未登录无法创建项目（返回401）
- [ ] 未登录无法修改资源
- [ ] 未登录无法删除资源

### 错误处理 ⭐

- [ ] 不存在的接口返回404
- [ ] 参数错误有友好提示
- [ ] 服务器错误有错误处理

---

## 常见问题和解决方案

### 问题1: 所有接口都无法访问

**症状**:
```
❌ 服务健康状态 - 错误: connect ECONNREFUSED
```

**原因**:
- 服务未启动
- URL错误
- 网络问题

**解决方案**:
1. 检查云托管服务状态
2. 确认URL拼写正确（包括https://）
3. 检查防火墙和网络设置

---

### 问题2: 环境诊断显示警告

**症状**:
```
❌ 环境配置异常: 数据库地址是本地地址，连接会失败！
```

**原因**:
- 环境变量未正确配置
- 使用了localhost而非内网地址

**解决方案**:
```bash
# 在云托管平台设置以下环境变量:
NODE_ENV=production
DB_HOST_INTERNAL=你的数据库内网地址
DB_PORT_INTERNAL=3306
DB_USER=数据库用户名
DB_PASSWORD=数据库密码
DB_NAME=数据库名称
```

---

### 问题3: 天气API失败

**症状**:
```
❌ 简单天气查询 - 错误: Request failed with status code 500
```

**原因**:
- 和风天气API密钥未配置
- 密钥无效或过期

**解决方案**:
```bash
# 在云托管平台设置环境变量:
QWEATHER_KEY=你的和风天气密钥
```

获取密钥: https://dev.qweather.com/

---

### 问题4: 权限保护失效

**症状**:
```
❌ 权限保护失效（未登录可以创建资源）
```

**原因**:
- 路由未使用认证中间件
- JWT配置错误

**解决方案**:
1. 检查路由文件中是否使用了 `authenticate` 中间件
2. 确认 `JWT_SECRET` 环境变量已设置
3. 查看 `docs/权限修复总结.md`

---

### 问题5: 业务接口返回空数据

**症状**:
```
✅ 项目列表
   共 0 个项目
```

**原因**:
- 数据库中没有数据
- 数据库连接失败

**解决方案**:
1. 检查数据库连接是否正常
2. 运行初始化脚本添加测试数据:
   ```bash
   npm run init-data
   ```

---

## 浏览器验证

如果不想使用命令行工具，可以直接在浏览器中验证：

### 关键接口

1. **健康检查**: `https://your-url.com/health`
2. **环境诊断**: `https://your-url.com/diagnose`
3. **API信息**: `https://your-url.com/api`
4. **项目列表**: `https://your-url.com/api/projects?page=1&pageSize=10`

### 检查要点

- ✅ 返回JSON格式
- ✅ 包含 `code`、`message`、`data` 字段
- ✅ `code: 0` 表示成功
- ✅ 响应时间 < 2秒

---

## CI/CD集成

### GitHub Actions

```yaml
name: API Verification
on:
  push:
    branches: [ master ]
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: npm install
      - run: node test/quick-verify.js ${{ secrets.API_BASE_URL }}
```

### 定时监控

```bash
# crontab -e
# 每5分钟检查一次
*/5 * * * * cd /path/to/project && node test/quick-verify.js https://your-url.com >> /var/log/api-verify.log 2>&1
```

---

## 性能基准

正常情况下的响应时间：

| 接口类型 | 期望响应时间 |
|---------|------------|
| 健康检查 | < 100ms |
| 环境诊断 | < 200ms |
| 天气查询 | < 500ms |
| 列表查询 | < 1s |
| 详情查询 | < 500ms |
| 创建操作 | < 1s |

如果响应时间明显超过这些值，可能存在性能问题。

---

## 相关文档

### 验证相关
- [快速验证指南](./快速验证指南.md) - 快速参考卡片
- [API接口验证指南](./API接口验证指南.md) - 详细验证指南
- [test/README.md](../test/README.md) - 测试工具使用说明

### 问题排查
- [权限修复总结](./权限修复总结.md) - 权限相关问题
- [AI对话优化修复总结](./AI对话优化修复总结.md) - AI功能问题
- [AI对话服务降级优化说明](./AI对话服务降级优化说明.md) - 服务降级

### API文档
- [c-api/README.md](./c-api/README.md) - API文档索引
- [实时语音识别API文档](./c-api/实时语音识别API文档.md)
- [天气查询API文档](./c-api/天气查询API文档.md)
- [Word导出API文档](./c-api/Word导出API文档.md)

---

## 总结

### 推荐使用方式

1. **新手**: 使用交互式验证工具
   ```bash
   npm run verify-interactive
   ```

2. **日常**: 使用快速验证工具
   ```bash
   node test/quick-verify.js https://your-url.com
   ```

3. **深度测试**: 使用完整验证工具
   ```bash
   npm run verify-api
   ```

### 关键验证点

- ✅ `/health` 返回 ok
- ✅ `/diagnose` 无警告
- ✅ 数据库连接正常
- ✅ 权限保护生效
- ✅ 业务接口可访问

### 验证通过标准

所有以下条件都满足：
1. 健康检查通过
2. 环境诊断无警告
3. 至少一个业务接口可访问
4. 权限保护正常工作
5. 响应时间在合理范围内

---

**最后更新**: 2024-11-08
**文档版本**: v1.0.0
**适用项目**: CloudBase 监理日志小程序后端

