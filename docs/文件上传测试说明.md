# 文件上传功能测试说明

## 测试前准备

### 1. 创建数据库表

云托管数据库需要先创建 `file_uploads` 表。执行以下SQL脚本：

**文件位置**: `scripts/create-file-uploads-table.sql`

或者直接在数据库中执行：

```sql
USE `jlzr1101-5g9kplxza13a780d`;

DROP TABLE IF EXISTS `file_uploads`;

CREATE TABLE `file_uploads` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '文件ID',
  `file_id` varchar(100) NOT NULL DEFAULT '' COMMENT '文件唯一标识ID',
  `user_id` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '上传用户ID',
  `file_name` varchar(500) NOT NULL DEFAULT '' COMMENT '文件名',
  `file_type` varchar(50) NOT NULL DEFAULT 'document' COMMENT '文件类型：image/document/video',
  `file_size` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '文件大小（字节）',
  `file_url` varchar(1000) NOT NULL DEFAULT '' COMMENT '文件访问URL（云存储）',
  `doubao_file_id` varchar(200) NOT NULL DEFAULT '' COMMENT '豆包文件ID',
  `upload_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_file_id` (`file_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_doubao_file_id` (`doubao_file_id`),
  KEY `idx_upload_time` (`upload_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件上传表（AI文件上传）';
```

### 2. 确保路由已注册

检查 `app.js` 中是否已注册文件上传路由：

```javascript
const fileUploadRouter = require('./routes/file-upload')
app.use('/api/file-upload', fileUploadRouter)
```

### 3. 确保环境变量配置

在云托管环境变量中配置：

- `DOUBAO_API_KEY` - 豆包API密钥
- `DOUBAO_API_URL` - 豆包API地址（默认：https://ark.cn-beijing.volces.com/api/v3）
- `SERVICE_DOMAIN` - 服务域名（https://api.yimengpl.com）

---

## 运行测试

### 使用测试脚本

运行测试脚本：

```bash
node test-file-upload.js
```

测试脚本会：
1. 自动登录获取token
2. 创建测试文件并上传
3. 显示上传结果
4. 获取文件列表

### 查看豆包返回数据

测试脚本会在服务器日志中打印豆包API的完整响应数据。查看云托管控制台的日志输出，查找以下标记：

- `[豆包上传] 请求URL: ...`
- `[豆包上传] 文件名: ...`
- `[豆包上传] 文件大小: ...`
- `[豆包上传] 豆包API完整响应数据:`
- `[豆包上传] 响应状态码: ...`
- `[豆包上传] 响应头: ...`
- `[豆包上传] 解析后的文件ID: ...`
- `[豆包上传] 解析后的文件URL: ...`（如果有）

---

## 豆包返回数据格式

根据代码实现，豆包API可能返回以下格式之一：

### 格式1：标准格式
```json
{
  "id": "file_xxx",
  "url": "https://..."
}
```

### 格式2：驼峰命名
```json
{
  "fileId": "file_xxx",
  "fileUrl": "https://..."
}
```

### 格式3：下划线命名
```json
{
  "file_id": "file_xxx",
  "file_url": "https://..."
}
```

代码会自动识别这些格式并提取文件ID和URL。

---

## 测试接口

### 1. 上传文件到豆包

**请求**:
```
POST https://api.yimengpl.com/api/file-upload/doubao
Content-Type: multipart/form-data
Authorization: Bearer {token}

FormData:
- file: 文件对象
- fileName: 文件名（可选）
- fileType: 文件类型（可选，默认document）
```

**响应**:
```json
{
  "code": 0,
  "message": "上传成功",
  "data": {
    "fileId": "file_1699200000000_abc12345",
    "fileUrl": "https://...",
    "fileName": "测试文件.txt",
    "fileType": "document",
    "fileSize": 106,
    "uploadTime": "2024-11-11T02:22:42.370Z"
  }
}
```

### 2. 获取文件列表

**请求**:
```
GET https://api.yimengpl.com/api/file-upload/list?page=1&pageSize=20
Authorization: Bearer {token}
```

**响应**:
```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "list": [
      {
        "fileId": "file_1699200000000_abc12345",
        "fileName": "测试文件.txt",
        "fileType": "document",
        "fileSize": 106,
        "fileUrl": "https://...",
        "doubaoFileId": "file_xxx",
        "uploadTime": "2024-11-11T02:22:42.000Z"
      }
    ]
  }
}
```

---

## 常见问题

### 1. 数据库表不存在

**错误**: `Table 'jlzr1101-5g9kplxza13a780d.file_uploads' doesn't exist`

**解决**: 执行 `scripts/create-file-uploads-table.sql` 创建表

### 2. 豆包上传失败

**可能原因**:
- API Key未配置或错误
- API URL配置错误
- 文件格式不支持
- 网络连接问题

**查看日志**: 检查云托管日志中的 `[豆包上传]` 标记

### 3. 文件URL为空

**说明**: 如果豆包API没有返回文件URL，系统会使用本地存储URL：
```
https://api.yimengpl.com/uploads/{fileId}.{ext}
```

---

## 下一步

1. 查看云托管日志，确认豆包返回的完整数据格式
2. 根据实际返回格式调整代码（如果需要）
3. 测试文件在AI对话中的使用

---

**测试时间**: 2024-11-11  
**测试服务器**: https://api.yimengpl.com

