# 语音识别功能配置指南

## 📋 概述

本文档说明如何配置和测试云托管环境下的语音识别功能。

## 🔧 配置步骤

### 1. 配置腾讯云凭证

在云托管控制台添加以下环境变量：

```
TENCENT_SECRET_ID=你的腾讯云SecretId
TENCENT_SECRET_KEY=你的腾讯云SecretKey
```

**获取凭证步骤**：
1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 [访问管理](https://console.cloud.tencent.com/cam/capi) -> API密钥管理
3. 创建或查看 SecretId 和 SecretKey
4. 确保密钥有**语音识别（ASR）**服务权限

### 2. 初始化数据库表

执行以下SQL创建语音识别日志表：

```sql
-- 语音识别日志表
CREATE TABLE IF NOT EXISTS `voice_recognition_logs` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` INT NOT NULL COMMENT '用户ID',
  `audio_size` INT DEFAULT 0 COMMENT '音频文件大小（字节）',
  `recognized_text` TEXT COMMENT '识别出的文字',
  `audio_time` INT DEFAULT 0 COMMENT '音频时长（毫秒）',
  `recognition_type` VARCHAR(50) DEFAULT 'realtime' COMMENT '识别类型：realtime-实时, sentence-一句话, wechat-微信',
  `options` TEXT COMMENT '识别选项（JSON格式）',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_created_at` (`created_at`),
  INDEX `idx_recognition_type` (`recognition_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='语音识别日志表';
```

或者运行初始化脚本：
```bash
mysql -u用户名 -p数据库名 < scripts/init-voice-recognition-tables.sql
```

### 3. 创建测试用户（可选）

如果需要使用测试用户进行测试：

```bash
node scripts/insert-test-user.js
```

或手动插入：
```sql
INSERT INTO users (openid, nickname) 
VALUES ('test_openid_888888', '测试用户');
```

## 🧪 测试步骤

### 1. 运行测试脚本

```bash
node test/test-voice-recognition-cloud.js
```

### 2. 测试结果说明

#### ✅ 健康检查
- 检查服务是否正常运行
- 接口: `GET /health`

#### ✅ 登录获取Token
- 使用测试用户登录
- 接口: `POST /api/auth/test-login`
- 返回JWT token用于后续认证

#### ❌ 语音识别失败
**错误**: `The provided credentials could not be validated`

**解决方案**:
1. 检查环境变量是否配置
2. 确认凭证有效且有ASR权限
3. 重启服务使配置生效

#### ❌ 历史记录/统计信息失败
**可能原因**:
1. 数据库表不存在
2. 查询出错

**解决方案**:
1. 执行建表SQL
2. 检查数据库连接配置

## 📝 接口说明

### 1. 一句话识别

**接口**: `POST /api/realtime-voice-socketio/recognize`

**请求**:
- Headers: `Authorization: Bearer {token}`
- Content-Type: `multipart/form-data`
- Body:
  - `audio`: 音频文件（PCM格式，16kHz，单声道）
  - `engineType`: 识别引擎（默认: 16k_zh）
  - `filterDirty`: 过滤脏词（0或1）
  - `filterModal`: 过滤语气词（0或1）
  - `convertNumMode`: 转换数字（0或1）
  - `wordInfo`: 词信息级别（0-2）

**响应**:
```json
{
  "code": 0,
  "message": "识别成功",
  "data": {
    "id": 123,
    "text": "识别出的文字",
    "audioTime": 1.5,
    "requestId": "xxx"
  }
}
```

### 2. 获取历史记录

**接口**: `GET /api/realtime-voice-socketio/history`

**请求**:
- Headers: `Authorization: Bearer {token}`
- Query参数:
  - `page`: 页码（默认: 1）
  - `pageSize`: 每页数量（默认: 20）

**响应**:
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 123,
        "audioSize": 15234,
        "recognizedText": "识别文字",
        "audioTime": 3000,
        "recognitionType": "realtime",
        "createdAt": "2024-11-06 10:00:00"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 10
    }
  }
}
```

### 3. 获取统计信息

**接口**: `GET /api/realtime-voice-socketio/stats`

**请求**:
- Headers: `Authorization: Bearer {token}`

**响应**:
```json
{
  "code": 0,
  "data": {
    "totalCount": 10,
    "totalAudioSize": 102400,
    "totalAudioTime": 60
  }
}
```

## 🔍 故障排查

### 问题1: 凭证验证失败

**错误信息**: `The provided credentials could not be validated`

**检查清单**:
- [ ] 环境变量 `TENCENT_SECRET_ID` 已配置
- [ ] 环境变量 `TENCENT_SECRET_KEY` 已配置
- [ ] 凭证值正确（无多余空格）
- [ ] 凭证有ASR服务权限
- [ ] 服务已重启使配置生效

**验证方法**:
```bash
# 查看诊断信息（如果接口可用）
curl https://api.yimengpl.com/diagnose
```

### 问题2: 数据库表不存在

**错误信息**: `Table 'xxx.voice_recognition_logs' doesn't exist`

**解决方案**:
1. 执行建表SQL（见上方）
2. 或运行初始化脚本

### 问题3: 音频格式错误

**错误信息**: 识别失败或返回空结果

**检查清单**:
- [ ] 音频格式: PCM（推荐）或MP3
- [ ] 采样率: 16kHz
- [ ] 声道: 单声道
- [ ] 时长: 60秒以内（一句话识别）

## 📚 相关文档

- [语音识别功能文档](./VOICE_RECOGNITION.md)
- [实时语音识别文档](../README_REALTIME_VOICE.md)
- [Socket.IO云托管集成指南](./Socket.IO云托管集成指南.md)
- [测试结果](../test/语音识别测试结果.md)

## 🚀 快速开始

1. **配置环境变量**（在云托管控制台）
2. **初始化数据库表**（执行SQL）
3. **创建测试用户**（可选）
4. **运行测试脚本**：
   ```bash
   node test/test-voice-recognition-cloud.js
   ```

## ⚠️ 注意事项

1. **凭证安全**: 不要将凭证提交到代码仓库
2. **音频格式**: 推荐使用PCM格式，16kHz采样率
3. **时长限制**: 一句话识别限制60秒以内
4. **权限要求**: 确保腾讯云密钥有ASR服务权限
5. **网络要求**: 需要稳定的网络连接访问腾讯云API

