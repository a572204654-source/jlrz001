# 文件上传 - 本地存储方案说明

## 概述

已实现**不使用云存储**的文件上传方案，文件直接保存在服务器本地，无需集成云存储服务（如腾讯云COS）。

---

## 实现方案

### 1. 文件存储位置

- **存储目录**: `public/uploads/`
- **文件命名**: `{fileId}.{扩展名}`（例如：`file_1699200000000_abc12345.pdf`）
- **自动创建**: 启动时自动创建上传目录（如果不存在）

### 2. 文件URL生成策略

文件URL的生成遵循以下优先级：

1. **优先使用豆包返回的URL**（如果豆包API上传文件后返回了文件URL）
2. **使用本地存储URL**：`{SERVICE_DOMAIN}/uploads/{fileId}.{ext}`

### 3. 文件访问方式

#### 方式一：通过API接口访问（推荐）

```
GET /api/file-upload/:fileId
Authorization: Bearer {token}
```

- 需要用户认证
- 只能访问自己的文件
- 自动设置正确的Content-Type
- 返回文件内容

#### 方式二：直接访问静态文件（如果配置了静态文件服务）

```
GET {domain}/uploads/{fileName}
```

- 通过Express静态文件服务直接访问
- 无需认证（注意：这种方式所有用户都可以访问，建议仅用于公开文件）

---

## 配置要求

### 环境变量配置

在 `.env` 文件中配置服务域名：

```env
SERVICE_DOMAIN=https://api.yimengpl.com
```

如果不配置，默认使用 `http://localhost`。

---

## 工作流程

### 上传流程

1. 前端上传文件到 `POST /api/file-upload/doubao`
2. 后端接收文件，保存到内存缓冲区
3. 同时执行两个操作：
   - 上传到豆包AI（用于AI读取）
   - 保存到本地 `public/uploads/` 目录
4. 生成文件URL（优先使用豆包URL，否则使用本地URL）
5. 保存文件信息到数据库
6. 返回文件信息给前端

### 访问流程

1. 前端调用 `GET /api/file-upload/:fileId`
2. 后端验证用户身份和文件所有权
3. 检查文件URL类型：
   - 如果是本地存储（包含 `/uploads/`），直接返回文件内容
   - 如果是豆包URL，返回文件信息JSON

### 删除流程

1. 前端调用 `DELETE /api/file-upload/:fileId`
2. 后端验证用户身份和文件所有权
3. 删除本地文件（如果存在）
4. 删除数据库记录

---

## 优势

1. **无需额外服务**: 不需要集成云存储服务，降低成本和复杂度
2. **简单直接**: 文件直接保存在服务器，访问简单
3. **完全控制**: 对文件存储和访问有完全控制权
4. **成本低**: 不需要支付云存储费用

---

## 注意事项

### 1. 存储空间

- 文件保存在服务器本地，需要确保服务器有足够的存储空间
- 建议定期监控 `public/uploads/` 目录的大小
- 可以设置存储空间上限和清理策略

### 2. 文件备份

- 建议定期备份 `public/uploads/` 目录
- 可以使用定时任务（如cron）自动备份
- 备份到其他服务器或云存储（仅用于备份，不是实时存储）

### 3. 服务器重启

- 文件保存在服务器本地，服务器重启不会丢失文件
- 但如果服务器被删除或重置，文件会丢失
- 建议配置持久化存储（如Docker volume）

### 4. 访问权限

- 通过API接口访问需要认证，安全性较好
- 如果使用静态文件服务直接访问，所有用户都可以访问，需要注意权限控制

### 5. 性能考虑

- 大量文件可能影响服务器性能
- 建议定期清理未使用的文件
- 可以考虑按日期或用户分目录存储

---

## 与云存储方案对比

| 特性 | 本地存储 | 云存储（COS） |
|------|---------|-------------|
| 成本 | 低（仅服务器存储） | 中（按存储和流量收费） |
| 复杂度 | 低（无需额外配置） | 中（需要配置云存储） |
| 可靠性 | 中（依赖服务器） | 高（云存储高可用） |
| 扩展性 | 低（受服务器限制） | 高（几乎无限扩展） |
| 访问速度 | 快（本地访问） | 中（需要网络请求） |
| 备份 | 需要手动配置 | 自动备份 |

---

## 迁移到云存储（可选）

如果将来需要迁移到云存储，可以：

1. 保持现有API接口不变
2. 修改文件上传逻辑，上传到云存储而不是本地
3. 修改文件URL生成逻辑，使用云存储URL
4. 可选：迁移现有文件到云存储

---

## 相关文件

- `routes/file-upload.js` - 文件上传路由实现
- `public/uploads/` - 文件存储目录（自动创建）
- `config/index.js` - 服务配置（SERVICE_DOMAIN）

---

**最后更新**: 2024-11-08

