# 文件上传功能实现说明

## 概述

已完成后端文件上传功能的开发，支持将文件流式上传到豆包AI服务，并在AI对话中使用文件。

**实现时间**: 2024-11-08

---

## 已完成的功能

### 1. 数据库表创建

在 `scripts/init-db-new.sql` 中新增了 `file_uploads` 表，用于存储文件上传信息：

- `file_id`: 文件唯一标识ID
- `user_id`: 上传用户ID
- `file_name`: 文件名
- `file_type`: 文件类型（image/document/video）
- `file_size`: 文件大小（字节）
- `file_url`: 文件访问URL
- `doubao_file_id`: 豆包文件ID（用于AI读取）
- `upload_time`: 上传时间

### 2. 文件上传接口

**路由**: `POST /api/file-upload/doubao`

**功能**:
- 接收multipart/form-data格式的文件上传
- 流式上传到豆包AI服务
- 保存文件信息到数据库
- 返回文件信息给前端

**实现文件**: `routes/file-upload.js`

**主要特性**:
- 使用multer处理文件上传（内存存储，支持流式上传）
- 文件大小限制：20MB
- 支持的文件类型：image/document/video
- 自动生成唯一文件ID
- 错误处理和日志记录

### 3. AI对话接口增强

**路由**: `POST /api/ai-chat/send`

**新增功能**:
- 支持 `files` 参数，可以携带文件列表
- 验证文件是否存在和已上传到豆包
- 将文件ID传递给豆包AI进行文件读取
- 支持纯文本、纯文件、或文本+文件混合发送

**实现文件**: `routes/ai-chat.js`

### 4. 豆包工具函数增强

**文件**: `utils/doubao.js`

**新增功能**:
- `chatWithContext` 函数支持 `fileIds` 参数
- 自动构建文件附件格式传递给豆包API
- 支持文件附件的AI对话

### 5. 文件管理接口

**路由**: 
- `GET /api/file-upload/list` - 获取用户上传的文件列表
- `DELETE /api/file-upload/:fileId` - 删除文件

---

## 技术实现细节

### 流式上传到豆包

使用 `form-data` 包创建multipart/form-data请求，将文件缓冲区直接流式上传到豆包API：

```javascript
const form = new FormData()
form.append('file', fileBuffer, {
  filename: fileName,
  contentType: getContentType(fileName)
})

const response = await axios.post(
  `${config.doubao.apiUrl}/files`,
  form,
  {
    headers: {
      ...form.getHeaders(),
      'Authorization': `Bearer ${config.doubao.apiKey}`
    },
    maxContentLength: Infinity,
    maxBodyLength: Infinity,
    timeout: 60000
  }
)
```

### 本地文件存储

文件上传后，同时保存到本地服务器：

```javascript
// 保存文件到本地
const localFilePath = path.join(uploadsDir, localFileName)
fs.writeFileSync(localFilePath, file.buffer)

// 生成文件URL（优先使用豆包URL，否则使用本地URL）
const fileUrl = doubaoFileUrl || `${config.server.domain}/uploads/${localFileName}`
```

### 文件类型识别

根据文件扩展名自动识别Content-Type，支持：
- 图片：jpg, jpeg, png, gif, webp
- 文档：pdf, doc, docx, xls, xlsx, ppt, pptx, txt, md
- 视频：mp4, avi, mov, wmv

### 错误处理

- 文件大小超限：返回400错误
- 文件类型不支持：返回400错误
- 豆包上传失败：记录错误，但仍保存文件记录（允许后续重试）
- 数据库错误：返回500错误

---

## API接口说明

### 1. 上传文件到豆包

**请求**:
```
POST /api/file-upload/doubao
Content-Type: multipart/form-data
Authorization: Bearer {token}

FormData:
- file: 文件对象（必填）
- fileName: 文件名（可选）
- fileType: 文件类型（可选，默认document）
```

**响应**:
```json
{
  "code": 0,
  "message": "上传成功",
  "data": {
    "fileId": "file_1699200000000_abc12345",
    "fileUrl": "https://api.yimengpl.com/files/file_1699200000000_abc12345.pdf",
    "fileName": "监理日志.pdf",
    "fileType": "document",
    "fileSize": 1024000,
    "uploadTime": "2024-10-21T10:00:00.000Z"
  },
  "timestamp": 1699200000000
}
```

### 2. 获取文件（访问/下载）

**请求**:
```
GET /api/file-upload/:fileId
Authorization: Bearer {token}
```

**响应**:
- 如果是本地存储的文件，直接返回文件内容
- 如果是豆包URL，返回文件信息JSON

### 3. AI对话发送消息（支持文件）

**请求**:
```
POST /api/ai-chat/send
Content-Type: application/json
Authorization: Bearer {token}

{
  "sessionId": "session_xxx",
  "content": "请帮我分析这个文件",
  "files": [
    {
      "fileId": "file_xxx",
      "fileUrl": "https://...",
      "fileName": "监理日志.pdf",
      "fileType": "document"
    }
  ]
}
```

**响应**:
```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "sessionId": "session_xxx",
    "messageId": 123,
    "aiReply": "我已经分析了您上传的监理日志文件..."
  },
  "timestamp": 1699200000000
}
```

---

## 使用流程

1. **前端上传文件**
   - 调用 `POST /api/file-upload/doubao` 上传文件
   - 获取返回的 `fileId` 和文件信息

2. **发送AI消息（携带文件）**
   - 调用 `POST /api/ai-chat/send`
   - 在 `files` 参数中传递文件信息
   - AI会自动读取文件内容并进行分析

3. **获取文件列表**
   - 调用 `GET /api/file-upload/list` 获取用户上传的文件列表

4. **访问文件**
   - 调用 `GET /api/file-upload/:fileId` 获取文件（需要认证）
   - 或直接访问 `{domain}/uploads/{fileName}`（如果配置了静态文件服务）

5. **删除文件**
   - 调用 `DELETE /api/file-upload/:fileId` 删除文件（同时删除本地文件和数据库记录）

---

## 存储方案（不使用云存储）

**已实现本地存储方案，无需使用云存储服务：**

1. **本地文件存储**: 文件保存到 `public/uploads/` 目录
2. **自动创建目录**: 启动时自动创建上传目录
3. **文件URL生成**: 
   - 优先使用豆包返回的文件URL（如果豆包API返回了URL）
   - 如果没有，使用本地存储URL：`{domain}/uploads/{fileId}.{ext}`
4. **文件访问**: 
   - 通过 `GET /api/file-upload/:fileId` 接口访问文件（需要认证）
   - 或直接通过 `{domain}/uploads/{fileName}` 访问（如果配置了静态文件服务）
5. **文件删除**: 删除文件时，同时删除本地文件和数据库记录

## 注意事项

1. **文件大小限制**: 单个文件最大20MB
2. **文件类型**: 支持image/document/video三种类型
3. **豆包上传**: 如果豆包上传失败，文件记录仍会保存，但 `doubao_file_id` 为空，需要重新上传
4. **本地存储**: 文件保存在服务器本地，需要确保服务器有足够的存储空间
5. **文件备份**: 建议定期备份 `public/uploads/` 目录
6. **响应格式**: 遵循项目规范，成功响应使用 `code: 0`（不是200）
7. **域名配置**: 需要在 `.env` 中配置 `SERVICE_DOMAIN` 环境变量，用于生成文件URL

---

## 待完善功能

1. **文件访问权限**: 已实现基础权限验证（只能访问自己的文件），可以进一步细化权限控制
2. **文件预览**: 可以添加文件预览功能（图片预览、PDF预览等）
3. **批量上传**: 可以支持一次上传多个文件
4. **文件清理**: 可以添加定期清理未使用文件的机制
5. **存储空间管理**: 可以添加存储空间使用情况监控和告警

---

## 测试建议

1. **文件上传测试**
   - 测试各种文件格式（PDF、Word、图片等）
   - 测试文件大小限制（超过20MB应返回错误）
   - 测试文件类型验证

2. **AI文件读取测试**
   - 上传文件后，在AI对话中携带文件
   - 验证AI是否能够读取文件内容
   - 测试AI对文件的分析能力

3. **错误场景测试**
   - 未登录上传：验证401错误
   - 文件过大：验证400错误
   - 文件格式不支持：验证400错误
   - 豆包上传失败：验证错误处理

---

## 相关文件

- `routes/file-upload.js` - 文件上传路由
- `routes/ai-chat.js` - AI对话路由（已增强）
- `utils/doubao.js` - 豆包工具函数（已增强）
- `scripts/init-db-new.sql` - 数据库初始化脚本（已更新）
- `app.js` - 应用入口（已注册路由）

---

**最后更新**: 2024-11-08

